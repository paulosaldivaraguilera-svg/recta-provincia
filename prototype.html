<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recta Provincia - El Cam铆n de la Sombra</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0808;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Georgia', serif;
            overflow: hidden;
        }
        #gameContainer { position: relative; }
        canvas {
            background: #0a0808;
            border: 4px solid #1a1210;
            border-radius: 2px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.9), inset 0 0 100px rgba(20, 10, 5, 0.5);
            display: block;
        }
        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            color: #8b7355;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
        }
        #karmaBar {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 14px;
            background: linear-gradient(to bottom, #1a1410, #0d0a08);
            border-radius: 7px;
            border: 2px solid #2d2015;
            overflow: hidden;
        }
        #karmaFill {
            height: 100%;
            width: 50%;
            background: linear-gradient(180deg, #63b3ed 0%, #2d5a7b 50%, #4a3728 70%, #6b3a3a 100%);
            transition: width 0.3s;
        }
        #karmaLabel {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            color: #5a4a3a;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
        }
        #statusEffects {
            position: absolute;
            top: 95px;
            left: 15px;
            color: #6b3a3a;
            font-size: 12px;
            font-style: italic;
        }
        #macunStatus {
            position: absolute;
            bottom: 15px;
            left: 15px;
            color: #5a4a3a;
            font-size: 12px;
            font-style: italic;
        }
        #transformStatus {
            position: absolute;
            bottom: 15px;
            right: 15px;
            color: #4a6b4a;
            font-size: 12px;
            font-style: italic;
        }
        #stressBar {
            position: absolute;
            top: 50px;
            right: 15px;
            width: 150px;
            height: 8px;
            background: linear-gradient(to bottom, #1a0a0a, #0d0505);
            border-radius: 4px;
            border: 1px solid #3d2015;
        }
        #stressFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4a3728, #6b3a3a, #8b0000);
            transition: width 0.3s;
        }
        #stressLabel {
            position: absolute;
            top: 62px;
            right: 15px;
            color: #6b3a3a;
            font-size: 10px;
            text-transform: uppercase;
        }
        #menu, #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(15, 10, 8, 0.97) 0%, rgba(5, 3, 2, 0.99) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border: 3px solid #2d2015;
        }
        #gameOver { display: none; }
        .title {
            font-size: 38px;
            color: #8b7355;
            text-shadow: 0 0 15px rgba(139, 115, 85, 0.4), 2px 2px 4px rgba(0,0,0,0.9);
            margin-bottom: 8px;
            letter-spacing: 4px;
        }
        .subtitle {
            color: #4a3728;
            font-size: 14px;
            margin-bottom: 30px;
            font-style: italic;
        }
        .quote {
            color: #5a4a3a;
            font-size: 13px;
            max-width: 450px;
            text-align: center;
            line-height: 1.7;
            margin-bottom: 25px;
            font-style: italic;
        }
        .menu-btn {
            background: linear-gradient(to bottom, #2d2015, #1a1410);
            border: 2px solid #3d2a1d;
            color: #8b7355;
            padding: 12px 40px;
            font-size: 14px;
            font-family: 'Georgia', serif;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            letter-spacing: 2px;
        }
        .menu-btn:hover {
            background: linear-gradient(to bottom, #3d2a1d, #2d2015);
            box-shadow: 0 0 15px rgba(139, 115, 85, 0.2);
        }
        .controls {
            color: #3d2a1d;
            font-size: 10px;
            margin-top: 30px;
            text-align: center;
            line-height: 1.8;
        }
        #notification {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #8b7355;
            font-size: 18px;
            text-shadow: 0 0 15px rgba(139, 115, 85, 0.6);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            text-align: center;
        }
        .vignette {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.4) 80%, rgba(0,0,0,0.8) 100%);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="game" width="960" height="640"></canvas>
        <div class="vignette"></div>
        
        <div id="ui">
            <span id="health">锔 Salud: 100</span>
            <span id="exp"> EXP: 0</span>
            <span id="level"> NV: 1</span>
        </div>
        
        <div id="stressBar"><div id="stressFill"></div></div>
        <div id="stressLabel">Locura</div>
        
        <div id="statusEffects"></div>
        
        <div id="karmaBar">
            <div id="karmaFill"></div>
        </div>
        <div id="karmaLabel">Karma</div>
        
        <div id="macunStatus">Д Macu帽: Piel de Oveja</div>
        <div id="transformStatus"> Transformaci贸n: Ninguna</div>
        
        <div id="notification"></div>
        
        <div id="menu">
            <div class="title">RECTA PROVINCIA</div>
            <div class="subtitle">"El Cam铆n de la Sombra"</div>
            <div class="quote">
                "En las tierras de Chilo茅, donde la niebla nunca se disipa,<br>
                el Mac煤n elige a sus portadores entre los marcados por el destino.<br>
                Algunos sucumben a la locura... otros la abrazan."
            </div>
            <button class="menu-btn" onclick="startGame()">COMENZAR</button>
            <div class="controls">
                WASD / FLECHAS Mover<br>
                A TRANSFORMARSE | ESPACIO ATACAR | SHIFT CORRER
            </div>
        </div>
        
        <div id="gameOver">
            <div class="title" style="color:#4a0000">FIN DEL CAMINO</div>
            <div class="subtitle" id="endKarma">Tu karma determin贸 tu destino...</div>
            <div class="quote" id="endQuote"></div>
            <button class="menu-btn" onclick="startGame()">REINTENTAR</button>
            <button class="menu-btn" onclick="showMenu()">MEN</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        const COLORS = {
            bg: '#0a0808',
            brown: '#2d2015',
            lightBrown: '#4a3728',
            red: '#6b3a3a',
            darkRed: '#4a2020',
            green: '#3d5a3d',
            gray: '#3d3d3d'
        };
        
        const state = {
            screen: 'menu',
            player: {
                x: 480, y: 320, width: 32, height: 48,
                speed: 2, health: 100, maxHealth: 100,
                stress: 0, maxStress: 100,
                exp: 0, level: 1, karma: 50,
                transform: 'human',
                macun: 'oveja',
                direction: 1,
                attacking: false,
                attackTimer: 0,
                glowIntensity: 0
            },
            enemies: [],
            particles: [],
            world: {
                width: 2400, height: 1600,
                tiles: [],
                trees: [],
                rocks: [],
                graves: [],
                fogPatches: []
            },
            keys: {},
            spawnTimer: 0,
            time: 0,
            cameraShake: 0
        };
        
        function generateWorld() {
            for (let x = 0; x < state.world.width; x += 60) {
                for (let y = 0; y < state.world.height; y += 60) {
                    if (Math.random() > 0.7) {
                        state.world.tiles.push({ x, y, variant: Math.floor(Math.random() * 3) });
                    }
                }
            }
            
            for (let i = 0; i < 100; i++) {
                state.world.trees.push({
                    x: Math.random() * state.world.width,
                    y: Math.random() * state.world.height,
                    width: 50 + Math.random() * 70,
                    height: 100 + Math.random() * 80,
                    dead: Math.random() > 0.6
                });
            }
            
            for (let i = 0; i < 60; i++) {
                state.world.graves.push({
                    x: Math.random() * state.world.width,
                    y: Math.random() * state.world.height,
                    type: Math.floor(Math.random() * 4),
                    tilted: Math.random() > 0.5
                });
            }
            
            for (let i = 0; i < 40; i++) {
                state.world.rocks.push({
                    x: Math.random() * state.world.width,
                    y: Math.random() * state.world.height,
                    size: 15 + Math.random() * 35
                });
            }
            
            for (let i = 0; i < 15; i++) {
                state.world.fogPatches.push({
                    x: Math.random() * state.world.width,
                    y: Math.random() * state.world.height,
                    width: 150 + Math.random() * 200,
                    opacity: 0.1 + Math.random() * 0.15,
                    speed: 0.1 + Math.random() * 0.2
                });
            }
        }
        
        generateWorld();
        
        function init() {
            document.addEventListener('keydown', e => {
                state.keys[e.key] = true;
                state.keys[e.code] = true;
            });
            document.addEventListener('keyup', e => {
                state.keys[e.key] = false;
                state.keys[e.code] = false;
            });
            requestAnimationFrame(gameLoop);
        }
        
        function startGame() {
            state.screen = 'playing';
            state.player = {
                x: 480, y: 320, width: 32, height: 48,
                speed: 2, health: 100, maxHealth: 100,
                stress: 0, maxStress: 100,
                exp: 0, level: 1, karma: 50,
                transform: 'human', macun: 'oveja',
                direction: 1, attacking: false,
                attackTimer: 0, glowIntensity: 0
            };
            state.enemies = [];
            state.particles = [];
            state.spawnTimer = 0;
            state.cameraShake = 0;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            updateUI();
        }
        
        function showMenu() {
            state.screen = 'menu';
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('gameOver').style.display = 'none';
        }
        
        function showNotification(text) {
            const notif = document.getElementById('notification');
            notif.textContent = text;
            notif.style.opacity = '1';
            setTimeout(() => notif.style.opacity = '0', 2000);
        }
        
        function updateUI() {
            const p = state.player;
            document.getElementById('health').textContent = `锔 Salud: ${Math.round(p.health)}`;
            document.getElementById('exp').textContent = ` EXP: ${p.exp}`;
            document.getElementById('level').textContent = ` NV: ${p.level}`;
            
            document.getElementById('karmaFill').style.width = p.karma + '%';
            document.getElementById('stressFill').style.width = p.stress + '%';
            
            let karmaLabel = 'EQUILIBRADO';
            if (p.karma < 20) karmaLabel = 'SOMBRA OSCURA';
            else if (p.karma < 40) karmaLabel = 'SOMBRA';
            else if (p.karma > 80) karmaLabel = 'LUZ SUPREMA';
            else if (p.karma > 60) karmaLabel = 'LUZ';
            document.getElementById('karmaLabel').textContent = karmaLabel;
            
            let statuses = [];
            if (p.stress > 50) statuses.push('お Locura');
            document.getElementById('statusEffects').textContent = statuses.join(' | ');
            
            const macunNames = { 'oveja': 'Piel de Oveja', 'caballo': 'Piel de Caballo', 'manusia': 'Piel de Hombre' };
            const transformNames = { 'human': 'Ninguna', 'alcatraz': 'Alcatraz (Luz)', 'chonchon': 'Chonch贸n (Sombra)' };
            document.getElementById('macunStatus').textContent = `Д Macu帽: ${macunNames[p.macun]}`;
            document.getElementById('transformStatus').textContent = ` ${transformNames[p.transform]}`;
        }
        
        function spawnEnemy() {
            const types = ['weka', 'piuchen', 'trauco', 'coleccionista'];
            const type = types[Math.floor(Math.random() * types.length)];
            const side = Math.floor(Math.random() * 4);
            let x, y;
            
            switch(side) {
                case 0: x = Math.random() * state.world.width; y = -50; break;
                case 1: x = state.world.width + 50; y = Math.random() * state.world.height; break;
                case 2: x = Math.random() * state.world.width; y = state.world.height + 50; break;
                case 3: x = -50; y = Math.random() * state.world.height; break;
            }
            
            const configs = {
                'weka': { health: 50, speed: 1.5, damage: 8, exp: 25, karma: -5, color: '#3d3d3d' },
                'piuchen': { health: 100, speed: 2, damage: 15, exp: 50, karma: 5, color: '#2d4a2d' },
                'trauco': { health: 40, speed: 3, damage: 20, exp: 40, karma: -10, color: '#4a2020' },
                'coleccionista': { health: 200, speed: 1, damage: 25, exp: 100, karma: -20, color: '#1a0a0a' }
            };
            
            const cfg = configs[type];
            state.enemies.push({
                x, y, type,
                health: cfg.health,
                maxHealth: cfg.health,
                speed: cfg.speed,
                damage: cfg.damage,
                exp: cfg.exp,
                karmaChange: cfg.karmaChange,
                color: cfg.color,
                animOffset: Math.random() * Math.PI * 2
            });
        }
        
        function createParticle(x, y, color, count, glow = false) {
            for (let i = 0; i < count; i++) {
                state.particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6 - 2,
                    life: 1,
                    color,
                    glow,
                    size: Math.random() * 4 + 2
                });
            }
        }
        
        function update() {
            if (state.screen !== 'playing') return;
            
            const p = state.player;
            state.time += 0.016;
            
            if (state.cameraShake > 0) state.cameraShake *= 0.9;
            
            let moveX = 0, moveY = 0;
            if (state.keys['ArrowLeft'] || state.keys['KeyA']) moveX -= 1;
            if (state.keys['ArrowRight'] || state.keys['KeyD']) moveX += 1;
            if (state.keys['ArrowUp'] || state.keys['KeyW']) moveY -= 1;
            if (state.keys['ArrowDown'] || state.keys['KeyS']) moveY += 1;
            
            const currentSpeed = (state.keys['ShiftLeft'] || state.keys['ShiftRight']) ? 3.5 : 2;
            
            if (moveX !== 0) p.direction = moveX > 0 ? 1 : -1;
            
            p.x += moveX * currentSpeed;
            p.y += moveY * currentSpeed;
            p.x = Math.max(25, Math.min(state.world.width - p.width - 25, p.x));
            p.y = Math.max(25, Math.min(state.world.height - p.height - 25, p.y));
            
            if (state.keys['KeyA'] && !state.keys['transformA']) {
                state.keys['transformA'] = true;
                if (p.karma > 60) {
                    p.transform = p.transform === 'alcatraz' ? 'human' : 'alcatraz';
                    showNotification(p.transform === 'alcatraz' ? ' ALCATRAZ' : ' Forma Humana');
                    createParticle(p.x, p.y, '#63b3ed', 25, true);
                } else if (p.karma < 40) {
                    p.transform = p.transform === 'chonchon' ? 'human' : 'chonchon';
                    showNotification(p.transform === 'chonchon' ? ' CHONCHN' : ' Forma Humana');
                    createParticle(p.x, p.y, '#2d4a2d', 25, true);
                }
            }
            if (!state.keys['KeyA']) state.keys['transformA'] = false;
            
            if ((state.keys[' '] || state.keys['Space']) && !p.attacking) {
                p.attacking = true;
                p.attackTimer = 20;
                state.cameraShake = 5;
                
                const range = p.transform === 'chonchon' ? 130 : 80;
                const damage = p.transform === 'chonchon' ? 60 : 30;
                const hitColor = p.karma > 50 ? '#63b3ed' : '#6b3a3a';
                
                state.enemies.forEach(e => {
                    const dist = Math.hypot(e.x - p.x, e.y - p.y);
                    if (dist < range) {
                        e.health -= damage;
                        createParticle(e.x, e.y, hitColor, 15);
                    }
                });
                createParticle(p.x, p.y, '#8b7355', 20, true);
            }
            if (!state.keys[' '] && !state.keys['Space']) p.attacking = false;
            if (p.attackTimer > 0) p.attackTimer--;
            
            if (Math.random() < 0.005 && p.stress < 100) {
                p.stress += 5;
                if (p.stress > 75 && Math.random() < 0.3) {
                    p.health -= 2;
                    showNotification('お ATAQUE DE PNICO');
                    state.cameraShake = 8;
                }
            }
            
            state.spawnTimer++;
            if (state.spawnTimer > 80 + Math.random() * 40) {
                spawnEnemy();
                state.spawnTimer = 0;
            }
            
            state.enemies = state.enemies.filter(e => {
                const dx = p.x - e.x;
                const dy = p.y - e.y;
                const dist = Math.hypot(dx, dy);
                
                if (dist > 5) {
                    e.x += (dx / dist) * e.speed;
                    e.y += (dy / dist) * e.speed;
                }
                
                if (dist < 40) {
                    p.health -= e.damage * 0.015;
                    p.stress = Math.min(100, p.stress + e.damage * 0.1);
                    createParticle(p.x, p.y, '#8b0000', 5);
                    state.cameraShake = 3;
                }
                
                if (e.health <= 0) {
                    p.exp += e.exp;
                    p.karma = Math.max(5, Math.min(95, p.karma + e.karmaChange));
                    createParticle(e.x, e.y, e.color, 30, true);
                    
                    if (e.type === 'coleccionista') {
                        showNotification(' COLECCIONISTA DERROTADO');
                    }
                    
                    if (p.exp >= p.level * 150) {
                        p.level++;
                        p.maxHealth += 30;
                        p.health = p.maxHealth;
                        p.stress = Math.max(0, p.stress - 30);
                        showNotification(` NIVEL ${p.level}`);
                        
                        if (p.level === 3) p.macun = 'caballo';
                        if (p.level === 5) p.macun = 'manusia';
                    }
                    
                    updateUI();
                    return false;
                }
                return true;
            });
            
            state.particles = state.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.vx *= 0.96;
                p.vy *= 0.96;
                return p.life > 0;
            });
            
            state.world.fogPatches.forEach(f => {
                f.x += f.speed;
                if (f.x > state.world.width + f.width) f.x = -f.width;
            });
            
            p.glowIntensity = Math.sin(state.time * 2) * 0.4 + 0.6;
            
            if (p.health <= 0) {
                state.screen = 'gameover';
                const karma = state.player.karma;
                let endText = '';
                let endQuote = '';
                
                if (p.stress >= 100) {
                    endText = 'LOCO PERMANENTE';
                    endQuote = '"La locura te consumi贸 por completo."';
                } else if (karma < 20) {
                    endText = 'IMBUNCHE';
                    endQuote = '"Las sombras te transformaron."';
                } else if (karma < 40) {
                    endText = 'BRUJO OSCURO';
                    endQuote = '"El Caleuche te adopt贸."';
                } else if (karma > 80) {
                    endText = 'MACHI SUPREMO';
                    endQuote = '"La luz de los ancestros brilla en ti."';
                } else if (karma > 60) {
                    endText = 'MACHI-BRUJO';
                    endQuote = '"Caminas entre dos mundos."';
                } else {
                    endText = 'EL OLVIDADO';
                    endQuote = '"Tu historia se pierde en la niebla."';
                }
                
                document.getElementById('endKarma').textContent = endText;
                document.getElementById('endQuote').textContent = endQuote;
                document.getElementById('gameOver').style.display = 'flex';
            }
        }
        
        function draw() {
            const p = state.player;
            const camX = Math.max(0, Math.min(state.world.width - canvas.width, p.x - canvas.width / 2));
            const camY = Math.max(0, Math.min(state.world.height - canvas.height, p.y - canvas.height / 2));
            
            const shakeX = (Math.random() - 0.5) * state.cameraShake;
            const shakeY = (Math.random() - 0.5) * state.cameraShake;
            
            ctx.save();
            ctx.translate(-camX + shakeX, -camY + shakeY);
            
            ctx.fillStyle = COLORS.bg;
            ctx.fillRect(camX - 50, camY - 50, canvas.width + 100, canvas.height + 100);
            
            state.world.tiles.forEach(t => {
                if (t.x >= camX - 60 && t.x <= camX + canvas.width + 60 &&
                    t.y >= camY - 60 && t.y <= camY + canvas.height + 60) {
                    ctx.fillStyle = t.variant === 0 ? '#12100e' : '#0d0a08';
                    ctx.fillRect(t.x, t.y, 58, 58);
                    ctx.strokeStyle = '#1a1410';
                    ctx.strokeRect(t.x, t.y, 58, 58);
                }
            });
            
            state.world.fogPatches.forEach(f => {
                const gradient = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, f.width / 2);
                gradient.addColorStop(0, `rgba(80, 90, 100, ${f.opacity})`);
                gradient.addColorStop(1, 'rgba(80, 90, 100, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(f.x - f.width / 2, f.y - 40, f.width, 80);
            });
            
            state.world.graves.forEach(g => {
                if (g.x >= camX - 40 && g.x <= camX + canvas.width + 40 &&
                    g.y >= camY - 40 && g.y <= camY + canvas.height + 40) {
                    ctx.fillStyle = '#2d2015';
                    if (g.type === 0) {
                        ctx.fillRect(g.x - 3, g.y - 25, 6, 35);
                        ctx.fillRect(g.x - 12, g.y - 15, 24, 6);
                    } else if (g.type === 1) {
                        ctx.beginPath();
                        ctx.moveTo(g.x - 12, g.y);
                        ctx.lineTo(g.x - 12, g.y - 25);
                        ctx.arc(g.x, g.y - 25, 12, Math.PI, 0);
                        ctx.lineTo(g.x + 12, g.y);
                        ctx.fill();
                    } else if (g.type === 2) {
                        ctx.beginPath();
                        ctx.arc(g.x, g.y - 5, 15, 0, Math.PI * 2);
                        ctx.arc(g.x - 8, g.y - 3, 10, 0, Math.PI * 2);
                        ctx.arc(g.x + 8, g.y - 3, 10, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.fillStyle = '#3d3d3d';
                        ctx.beginPath();
                        ctx.arc(g.x, g.y - 10, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            });
            
            state.world.rocks.forEach(r => {
                const rockGrad = ctx.createRadialGradient(r.x, r.y, 0, r.x, r.y, r.size);
                rockGrad.addColorStop(0, '#3d3528');
                rockGrad.addColorStop(1, '#1a1410');
                ctx.fillStyle = rockGrad;
                ctx.beginPath();
                ctx.arc(r.x, r.y, r.size, 0, Math.PI * 2);
                ctx.fill();
            });
            
            state.world.trees.forEach(t => {
                if (t.x >= camX - t.width && t.x <= camX + canvas.width + t.width &&
                    t.y >= camY - t.height && t.y <= camY + canvas.height + t.height) {
                    ctx.fillStyle = t.dead ? '#1a1410' : '#2d2015';
                    ctx.beginPath();
                    ctx.moveTo(t.x - t.width / 3, t.y + t.height);
                    ctx.quadraticCurveTo(t.x - t.width / 2, t.y + t.height * 0.6, t.x - t.width / 4, t.y);
                    ctx.quadraticCurveTo(t.x, t.y - t.height * 0.2, t.x + t.width / 4, t.y);
                    ctx.quadraticCurveTo(t.x + t.width / 3, t.y + t.height * 0.4, t.x + t.width / 3, t.y + t.height);
                    ctx.fill();
                    
                    if (t.dead) {
                        ctx.strokeStyle = '#0a0808';
                        ctx.lineWidth = 3;
                        for (let i = 0; i < 5; i++) {
                            const bx = t.x + (Math.random() - 0.5) * t.width * 0.8;
                            const by = t.y + Math.random() * t.height * 0.5;
                            ctx.beginPath();
                            ctx.moveTo(bx, by);
                            ctx.lineTo(bx + (Math.random() - 0.5) * 40, by - 30 - Math.random() * 20);
                            ctx.stroke();
                        }
                    }
                }
            });
            
            state.particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                if (p.glow) {
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 12;
                }
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
            
            state.enemies.forEach(e => {
                ctx.fillStyle = '#0a0808';
                ctx.fillRect(e.x - 25, e.y - 35, 50, 8);
                ctx.fillStyle = e.color;
                ctx.fillRect(e.x - 25, e.y - 35, 50 * (e.health / e.maxHealth), 8);
                
                ctx.save();
                ctx.translate(e.x, e.y);
                const bounce = Math.sin(state.time * 5 + e.animOffset) * 3;
                
                if (e.type === 'weka') {
                    ctx.fillStyle = '#2d2d2d';
                    ctx.beginPath();
                    ctx.ellipse(0, bounce, 20, 25, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#8b0000';
                    ctx.beginPath();
                    ctx.arc(-7, bounce - 5, 4, 0, Math.PI * 2);
                    ctx.arc(7, bounce - 5, 4, 0, Math.PI * 2);
                    ctx.fill();
                } else if (e.type === 'piuchen') {
                    ctx.fillStyle = '#1a2a1a';
                    ctx.beginPath();
                    ctx.ellipse(0, bounce, 25, 40, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#2d4a2d';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 4; i++) {
                        ctx.beginPath();
                        ctx.moveTo(-20, bounce - 20 + i * 20);
                        ctx.lineTo(20, bounce - 15 + i * 20);
                        ctx.stroke();
                    }
                } else if (e.type === 'trauco') {
                    ctx.fillStyle = '#2d1010';
                    ctx.beginPath();
                    ctx.moveTo(0, bounce - 40);
                    ctx.lineTo(25, bounce + 20);
                    ctx.lineTo(-25, bounce + 20);
                    ctx.fill();
                    ctx.fillStyle = '#4a0000';
                    ctx.beginPath();
                    ctx.arc(0, bounce - 10, 8, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = '#0a0505';
                    ctx.beginPath();
                    ctx.ellipse(0, bounce, 35, 50, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#8b0000';
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc(-15 + i * 15, bounce - 20, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                ctx.restore();
            });
            
            ctx.save();
            ctx.translate(p.x + p.width / 2, p.y + p.height / 2);
            ctx.scale(p.direction, 1);
            
            if (p.karma > 50) {
                ctx.shadowColor = '#63b3ed';
                ctx.shadowBlur = 15 * p.glowIntensity;
            } else if (p.karma < 50) {
                ctx.shadowColor = '#3d5a3d';
                ctx.shadowBlur = 15 * p.glowIntensity;
            }
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.beginPath();
            ctx.ellipse(0, p.height / 2 - 5, 20, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            
            const macunColors = { 'oveja': '#3d2a1d', 'caballo': '#4a3728', 'manusia': '#2d2015' };
            
            ctx